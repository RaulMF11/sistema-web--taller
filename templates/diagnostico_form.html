{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-gradient-primary text-white text-center py-4" style="background: linear-gradient(45deg, #0d6efd, #0dcaf0);">
                    <h3 class="mb-0 fw-bold"><i class="fas fa-robot me-2"></i>Asistente de Diagnóstico IA</h3>
                    <p class="mb-0 opacity-75">Sistema Predictivo Basado en Historial y Síntomas</p>
                </div>

                <div class="card-body p-5">
                    <form method="post" id="aiForm">
                        {% csrf_token %}

                        <h5 class="text-primary mb-4 border-bottom pb-2"><i class="fas fa-car me-2"></i>Identificación del Vehículo</h5>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                {{ form.placa|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.propietario|as_crispy_field }}
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Marca</label>
                                {{ form.marca_select }}
                                {{ form.marca }} </div>
                            <div class="col-md-6">
                                <label class="form-label">Modelo</label>
                                {{ form.modelo_select }}
                                {{ form.modelo }} </div>
                            
                            <div class="col-md-4">
                                {{ form.anio|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.kilometraje|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.ultimo_mantenimiento|as_crispy_field }}
                            </div>
                        </div>

                        <div class="bg-light p-4 rounded-3 border mb-4">
                            <h5 class="text-danger mb-3"><i class="fas fa-stethoscope me-2"></i>Descripción de Síntomas</h5>
                            <div class="alert alert-warning small py-2">
                                <i class="fas fa-lightbulb me-1"></i> Tip: Describe ruidos (chillido, golpe), sensaciones (vibración, jaloneo) y cuándo ocurre (al frenar, en frío).
                            </div>
                            {{ form.descripcion_sintomas|as_crispy_field }}
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg py-3 rounded-pill fw-bold shadow" id="btnAnalizar">
                                <span id="btnText"><i class="fas fa-brain me-2"></i>ANALIZAR FALLA CON IA</span>
                                <span id="btnSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .btn-execute-ai {
        background: linear-gradient(135deg, #003087 0%, #0056b3 100%);
        color: white;
        font-weight: 800;
        font-size: 1.2rem;
        padding: 15px 30px;
        border: none;
        border-radius: 50px;
        box-shadow: 0 10px 20px -10px rgba(0, 48, 135, 0.5);
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .btn-execute-ai:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px -10px rgba(0, 48, 135, 0.7);
        background: linear-gradient(135deg, #0042b5 0%, #0069d9 100%);
        color: #ffd100;
    }
    .btn-execute-ai:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // --- REFERENCIAS A LOS ELEMENTOS ---
        const form = document.getElementById("aiForm");
        
        // Campos visibles (Selects de UI)
        const selectMarca = document.getElementById("id_marca_select");
        const selectModelo = document.getElementById("id_modelo_select");
        
        // Campos ocultos (Lo que se envía a la BD y a la IA)
        const inputMarcaTexto = document.getElementById("id_marca_texto");
        const inputModeloTexto = document.getElementById("id_modelo_texto");

        // Otros campos
        const inputPlaca = document.getElementById("id_placa");
        const inputPropietario = document.getElementById("id_propietario");
        const inputAnio = document.getElementById("id_anio");

        // Botón de carga
        const btnAnalizar = document.getElementById("btnAnalizar");
        const btnText = document.getElementById("btnText");
        const btnSpinner = document.getElementById("btnSpinner");

        // --- 1. LÓGICA DE DROPDOWNS EN CASCADA ---
        
        // Estado inicial: Bloquear modelo si no hay marca
        if (!selectMarca.value) {
            selectModelo.innerHTML = '<option value="">Primero selecciona marca</option>';
            selectModelo.disabled = true;
        }

        // Escuchar cambios en la MARCA
        if (selectMarca) {
            selectMarca.addEventListener("change", function () {
                const marcaId = this.value;
                const marcaNombre = this.options[this.selectedIndex].text;

                // 1. Llenar el input oculto de texto para la IA
                if(inputMarcaTexto) inputMarcaTexto.value = marcaNombre;

                // 2. Resetear select de modelos
                selectModelo.innerHTML = '<option value="">Cargando modelos...</option>';
                selectModelo.disabled = true;

                if (marcaId) {
                    // Petición AJAX para traer modelos LIMPIOS (Sin paréntesis)
                    fetch(`{% url 'ajax_load_modelos' %}?marca_id=${marcaId}`)
                        .then(response => response.json())
                        .then(data => {
                            selectModelo.innerHTML = '<option value="">Selecciona Modelo</option>';
                            
                            data.forEach(item => {
                                const option = document.createElement('option');
                                option.value = item.id_modelo; // ID para Django
                                option.textContent = item.nombre_modelo; // NOMBRE LIMPIO para el usuario
                                selectModelo.appendChild(option);
                            });
                            selectModelo.disabled = false;
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            selectModelo.innerHTML = '<option value="">Error al cargar</option>';
                        });
                } else {
                    selectModelo.innerHTML = '<option value="">Primero selecciona marca</option>';
                }
            });
        }

        // Escuchar cambios en el MODELO
        if (selectModelo) {
            selectModelo.addEventListener("change", function () {
                // Al elegir modelo, guardamos el TEXTO LIMPIO en el input oculto
                if (this.selectedIndex >= 0 && inputModeloTexto) {
                    inputModeloTexto.value = this.options[this.selectedIndex].text;
                }
            });
        }

        // --- 2. BUSCAR PLACA (Auto-completado) ---
if(inputPlaca){
            inputPlaca.addEventListener("blur", function() {
                const placa = inputPlaca.value.trim();
                
                if(placa.length > 3) {
                    // Pone un estado de carga visual
                    if(inputPropietario) inputPropietario.placeholder = "Buscando...";
                    
                    fetch(`{% url 'ajax_buscar_placa' %}?placa=${placa}`)
                    .then(response => response.json())
                    .then(data => {
                        if(data.encontrado){
                            // 1. Llenar datos básicos
                            if(inputPropietario) inputPropietario.value = data.propietario;
                            if(inputAnio) inputAnio.value = data.anio;
                            
                            // 2. Llenar MARCA
                            if(selectMarca) {
                                selectMarca.value = data.marca_id;
                                // Actualizar también el input oculto de texto de la marca
                                if(inputMarcaTexto) inputMarcaTexto.value = data.marca_nombre;
                                selectMarca.disabled = false; // Asegurar que esté habilitado
                            }

                            // 3. CARGAR MODELOS Y SELECCIONAR EL CORRECTO (Aquí estaba el fallo)
                            if (selectModelo && data.marca_id) {
                                selectModelo.innerHTML = '<option value="">Cargando modelo...</option>';
                                
                                // Hacemos el fetch manual aquí para asegurar el orden
                                fetch(`{% url 'ajax_load_modelos' %}?marca_id=${data.marca_id}`)
                                    .then(res => res.json())
                                    .then(modelos => {
                                        // A. Limpiar y llenar el dropdown
                                        selectModelo.innerHTML = '<option value="">Selecciona Modelo</option>';
                                        
                                        modelos.forEach(m => {
                                            const opt = document.createElement('option');
                                            opt.value = m.id_modelo;
                                            opt.textContent = m.nombre_modelo;
                                            selectModelo.appendChild(opt);
                                        });

                                        // B. AHORA SÍ: Seleccionar el modelo específico
                                        selectModelo.value = data.modelo_id;
                                        selectModelo.disabled = false;

                                        // C. IMPORTANTE: Actualizar el input oculto para que se guarde bien
                                        if(inputModeloTexto) inputModeloTexto.value = data.modelo_nombre;
                                    })
                                    .catch(err => {
                                        console.error("Error cargando modelos:", err);
                                        selectModelo.innerHTML = '<option value="">Error manual</option>';
                                    });
                            }
                            
                            inputPlaca.classList.add("is-valid");
                            inputPlaca.classList.remove("is-invalid");
                        } else {
                            // Si no existe, limpiar para que escriban uno nuevo
                            inputPlaca.classList.remove("is-valid");
                            // Opcional: inputPropietario.value = "";
                        }
                    })
                    .catch(e => console.error("Error buscando placa:", e));
                }
            });
        }

        // --- 3. UI AL ENVIAR EL FORMULARIO ---
        if (form) {
            form.addEventListener("submit", function () {
                // Desbloquear campos para que se envíen en el POST
                if(selectMarca) selectMarca.disabled = false;
                if(selectModelo) selectModelo.disabled = false;

                if(btnAnalizar) {
                    btnAnalizar.disabled = true;
                    btnText.innerText = " Analizando con IA...";
                    btnSpinner.classList.remove("d-none");
                }
            });
        }
    });
</script>
{% endblock %}