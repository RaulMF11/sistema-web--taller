{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 rounded-4">
                <div class="card-header bg-gradient-primary text-white text-center py-4" style="background: linear-gradient(45deg, #0d6efd, #0dcaf0);">
                    <h3 class="mb-0 fw-bold"><i class="fas fa-robot me-2"></i>Asistente de Diagnóstico IA</h3>
                    <p class="mb-0 opacity-75">Sistema Predictivo Basado en Historial y Síntomas</p>
                </div>

                <div class="card-body p-5">
                    <form method="post" id="aiForm">
                        {% csrf_token %}

                        <h5 class="text-primary mb-4 border-bottom pb-2"><i class="fas fa-car me-2"></i>Identificación del Vehículo</h5>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                {{ form.placa|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.propietario|as_crispy_field }}
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Marca</label>
                                {{ form.marca_select }}
                                {{ form.marca }} </div>
                            <div class="col-md-6">
                                <label class="form-label">Modelo</label>
                                {{ form.modelo_select }}
                                {{ form.modelo }} </div>
                            
                            <div class="col-md-4">
                                {{ form.anio|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.kilometraje|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.ultimo_mantenimiento|as_crispy_field }}
                            </div>
                        </div>

                        <div class="bg-light p-4 rounded-3 border mb-4">
                            <h5 class="text-danger mb-3"><i class="fas fa-stethoscope me-2"></i>Descripción de Síntomas</h5>
                            <div class="alert alert-warning small py-2">
                                <i class="fas fa-lightbulb me-1"></i> Tip: Describe ruidos (chillido, golpe), sensaciones (vibración, jaloneo) y cuándo ocurre (al frenar, en frío).
                            </div>
                            {{ form.descripcion_sintomas|as_crispy_field }}
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary btn-lg py-3 rounded-pill fw-bold shadow" id="btnAnalizar">
                                <span id="btnText"><i class="fas fa-brain me-2"></i>ANALIZAR FALLA CON IA</span>
                                <span id="btnSpinner" class="spinner-border spinner-border-sm d-none ms-2"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .btn-execute-ai {
        background: linear-gradient(135deg, #003087 0%, #0056b3 100%);
        color: white;
        font-weight: 800;
        font-size: 1.2rem;
        padding: 15px 30px;
        border: none;
        border-radius: 50px;
        box-shadow: 0 10px 20px -10px rgba(0, 48, 135, 0.5);
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    .btn-execute-ai:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px -10px rgba(0, 48, 135, 0.7);
        background: linear-gradient(135deg, #0042b5 0%, #0069d9 100%);
        color: #ffd100;
    }
    .btn-execute-ai:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const form = document.getElementById("aiForm");
    const inputPlaca = document.getElementById("id_placa");
    const inputPropietario = document.getElementById("id_propietario");
    const inputAnio = document.getElementById("id_anio");
    const selectMarca = document.getElementById("id_marca_select");
    const inputMarcaTexto = document.getElementById("id_marca_texto");
    const selectModelo = document.getElementById("id_modelo_select");
    const inputModeloTexto = document.getElementById("id_modelo_texto");

    function bloquearCampos() {
        if(inputAnio) { inputAnio.readOnly = true; inputAnio.classList.add('bg-light'); }
        // if(inputPropietario) { inputPropietario.readOnly = true; inputPropietario.classList.add('bg-light'); }
        if(selectMarca) selectMarca.disabled = true;
        if(selectModelo) selectModelo.disabled = true;
    }

    function desbloquearCampos() {
        if(inputAnio) { inputAnio.readOnly = false; inputAnio.classList.remove('bg-light'); inputAnio.value = ""; }
        if(inputPropietario) { inputPropietario.readOnly = false; inputPropietario.classList.remove('bg-light'); inputPropietario.value = ""; }
        if(selectMarca) { selectMarca.disabled = false; selectMarca.value = ""; }
        if(selectModelo) { selectModelo.disabled = false; selectModelo.innerHTML = '<option value="">Primero selecciona marca</option>'; }
    }

    if (form) {
        form.addEventListener("submit", function () {
            // DESBLOQUEAR ANTES DE ENVIAR PARA QUE DJANGO RECIBA LOS DATOS
            if(selectMarca) selectMarca.disabled = false;
            if(selectModelo) selectModelo.disabled = false;

            var btn = document.getElementById("btnAnalizar");
            var text = document.getElementById("btnText");
            var spinner = document.getElementById("btnSpinner");
            if(btn && text && spinner) {
                btn.disabled = true;
                text.innerText = " Procesando...";
                spinner.classList.remove("d-none");
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        // 1. BUSCAR PLACA
        if(inputPlaca){
            inputPlaca.addEventListener("blur", function() {
                const placa = inputPlaca.value.trim();
                if(placa.length > 3) {
                    fetch(`{% url 'ajax_buscar_placa' %}?placa=${placa}`)
                    .then(response => response.json())
                    .then(data => {
                        if(data.encontrado){
                            // Llenar datos
                            if(inputPropietario) inputPropietario.value = data.propietario;
                            if(inputAnio) inputAnio.value = data.anio;

                            // Llenar Marca y cargar modelos
                            if(selectMarca) {
                                selectMarca.value = data.marca_id;
                                if(inputMarcaTexto) inputMarcaTexto.value = data.marca_nombre;
                                
                                // Cargar modelos
                                fetch(`{% url 'ajax_load_modelos' %}?marca_id=${data.marca_id}`)
                                .then(res => res.json())
                                .then(modelos => {
                                    if(selectModelo){
                                        selectModelo.innerHTML = '';
                                        modelos.forEach(m => {
                                            const opt = document.createElement('option');
                                            opt.value = m.id_modelo;
                                            opt.textContent = m.nombre_modelo;
                                            selectModelo.appendChild(opt);
                                        });
                                        selectModelo.value = data.modelo_id;
                                        if(inputModeloTexto) inputModeloTexto.value = data.modelo_nombre;
                                        
                                        // BLOQUEAR AL FINAL
                                        bloquearCampos();
                                    }
                                });
                            }
                            inputPlaca.classList.add("is-valid");
                        } else {
                            desbloquearCampos();
                        }
                    });
                }
            });
        }

        // 2. CAMBIO DE MARCA MANUAL
        if (selectMarca) {
            selectMarca.addEventListener("change", function () {
                const marcaId = selectMarca.value;
                if(selectMarca.selectedIndex >=0 && inputMarcaTexto) 
                    inputMarcaTexto.value = selectMarca.options[selectMarca.selectedIndex].text;

                if(selectModelo && marcaId) {
                    selectModelo.innerHTML = '<option>Cargando...</option>';
                    fetch(`{% url 'ajax_load_modelos' %}?marca_id=${marcaId}`)
                    .then(r => r.json())
                    .then(data => {
                        selectModelo.innerHTML = '<option value="">Selecciona Modelo</option>';
                        data.forEach(m => {
                            const opt = document.createElement('option');
                            opt.value = m.id_modelo;
                            opt.textContent = m.nombre_modelo;
                            selectModelo.appendChild(opt);
                        });
                    });
                }
            });
        }
        
        // 3. CAMBIO DE MODELO MANUAL
        if (selectModelo && inputModeloTexto) {
            selectModelo.addEventListener("change", function () {
                if (selectModelo.selectedIndex >= 0) inputModeloTexto.value = selectModelo.options[selectModelo.selectedIndex].text;
            });
        }
    });
</script>
{% endblock %}